services:
  mcp-fhir-agent:
    depends_on:
      mongo:
        condition: service_healthy
      fhir:
        condition: service_healthy
      mongo-restore-drop:
        condition: service_completed_successfully
    build:
      context: ../mcp-fhir-agent
      dockerfile: Dockerfile
      args:
        GITHUB_TOKEN: ${GITHUB_TOKEN}
    image: mcp-fhir-agent:local
    environment: &agent_env
      DEBUG_METRICS: 0
      LOG_LEVEL: DEBUG
      GITHUB_TOKEN: ${GITHUB_TOKEN}
      DEFAULT_PATIENT_ID: "d58b4c4d-e820-5935-adfc-4cb372a91c22"
      DEFAULT_PERSON_ID: "072b2b1c-942d-542c-8e51-f9dc0dadcc0a"
      # Disable AWS EC2 metadata service to speed up tests and silence IMDS probing
      AWS_EC2_METADATA_DISABLED: "true"
      AWS_DEFAULT_REGION: "us-east-1"
      # configuration for local testing
      FHIR_SERVER_GRAPHQL_URL: 'http://fhir:3000/4_0_0/$$graphqlv2'
      FHIR_SERVER_MERGE_URL: 'http://fhir:3000/4_0_0/Bundle/$$merge'
      FHIR_SERVER_GET_URL: ${FHIR_SERVER_GET_URL:-http://fhir:3000/4_0_0/}
      # FHIR_SERVER_GET_URL: 'https://fhir-internal.staging.bwell.zone/4_0_0/'
      # FHIR_SERVER_GET_URL: 'https://fhir-internal.client-sandbox.bwell.zone/4_0_0/'
      #      FHIR_SERVER_GET_URL: 'https://fhir-internal.dev.bwell.zone/4_0_0/'
      FHIR_ADMIN_USERNAME: 'admin'
      FHIR_ADMIN_PASSWORD: 'password'
      FHIR_SERVER_GET_LIMIT: 100
      # service account used to connect to OAuth IDP
      CLIENT_ID: ${CLIENT_ID:-bwell-client-id}
      CLIENT_SECRET: ${CLIENT_SECRET:-bwell-secret}
      MAXIMUM_RESPONSE_TOKENS: ${MAXIMUM_RESPONSE_TOKENS:-8000}
      # Below we specify the client id, client secret and well-known URI for each client
      # For list-like env vars, do NOT use quotes in the default value to avoid extra quotes in Python parsing
      AUTH_PROVIDERS: ${AUTH_PROVIDERS:-client1,client3,oktafhirdev,oktafhirclientsandbox}
      #      AUTH_PROVIDERS: "client1,client3,okta,clientsandbox,cognito"
      # first client for testing
      AUTH_ISSUER_CLIENT1: ${AUTH_ISSUER_CLIENT1:-http://keycloak:8080/realms/bwell-realm}
      AUTH_AUDIENCE_CLIENT1: ${AUTH_AUDIENCE_CLIENT1:-client1}
      AUTH_CLIENT_ID_CLIENT1: ${AUTH_CLIENT_ID_CLIENT1:-bwell-client-id}
      AUTH_CLIENT_SECRET_CLIENT1: ${AUTH_CLIENT_SECRET_CLIENT1:-bwell-secret}
      AUTH_WELL_KNOWN_URI_CLIENT1: ${AUTH_WELL_KNOWN_URI_CLIENT1:-http://keycloak:8080/realms/bwell-realm/.well-known/openid-configuration}
      # second client for testing
      AUTH_ISSUER_CLIENT3: ${AUTH_ISSUER_CLIENT3:-http://keycloak:8080/realms/bwell-realm}
      AUTH_AUDIENCE_CLIENT3: ${AUTH_AUDIENCE_CLIENT3:-client3}
      AUTH_CLIENT_ID_CLIENT3: ${AUTH_CLIENT_ID_CLIENT3:-bwell-client-id-3}
      AUTH_CLIENT_SECRET_CLIENT3: ${AUTH_CLIENT_SECRET_CLIENT3:-bwell-secret-3}
      AUTH_WELL_KNOWN_URI_CLIENT3: ${AUTH_WELL_KNOWN_URI_CLIENT3:-http://keycloak:8080/realms/bwell-realm/.well-known/openid-configuration}
      # Okta for dev and production
      AUTH_ISSUER_OKTA: ${AUTH_ISSUER_OKTA:-https://icanbwell.okta.com}
      # AUTH_CLIENT_ID_OKTA and AUTH_CLIENT_SECRET_OKTA are read from the docker.env file
      AUTH_WELL_KNOWN_URI_OKTA: ${AUTH_WELL_KNOWN_URI_OKTA:-https://icanbwell.okta.com/.well-known/openid-configuration}
      # Okta FHIR Dev
      AUTH_ISSUER_OKTAFHIRDEV: ${AUTH_ISSUER_OKTAFHIRDEV:-https://icanbwell.okta.com}
      AUTH_AUDIENCE_OKTAFHIRDEV: ${AUTH_AUDIENCE_OKTAFHIRDEV:-0oarf29h6x2DaWCkT697}
      AUTH_CLIENT_ID_OKTAFHIRDEV: ${AUTH_CLIENT_ID_OKTAFHIRDEV:-0oarf29h6x2DaWCkT697}
      AUTH_WELL_KNOWN_URI_OKTAFHIRDEV: ${AUTH_WELL_KNOWN_URI_OKTAFHIRDEV:-https://icanbwell.okta.com/.well-known/openid-configuration}
      # Okta FHIR Client Sandbox
      AUTH_ISSUER_OKTAFHIRCLIENTSANDBOX: ${AUTH_ISSUER_OKTAFHIRCLIENTSANDBOX:-https://icanbwell.okta.com}
      AUTH_AUDIENCE_OKTAFHIRCLIENTSANDBOX: ${AUTH_AUDIENCE_OKTAFHIRCLIENTSANDBOX:-0oari2d229YaZYiZD697}
      AUTH_CLIENT_ID_OKTAFHIRCLIENTSANDBOX: ${AUTH_CLIENT_ID_OKTAFHIRCLIENTSANDBOX:-0oari2d229YaZYiZD697}
      AUTH_WELL_KNOWN_URI_OKTAFHIRCLIENTSANDBOX: ${AUTH_WELL_KNOWN_URI_OKTAFHIRCLIENTSANDBOX:-https://icanbwell.okta.com/.well-known/openid-configuration}
      # This is the URL that the user will be redirected to after authentication
      AUTH_REDIRECT_URI: ${AUTH_REDIRECT_URI:-https://mcpfhiragent.localhost/auth_test/callback}
      # This is used to store state and nonce for OIDC auth code flow
      MONGO_URL: "mongodb://mongo:27017?appName=mcp-fhir-agent"
      MONGO_DB_NAME: mcp_fhir_agent
      MONGO_DB_AUTH_CACHE_COLLECTION_NAME: oauth_cache
      MONGO_DB_USERNAME: "root"
      MONGO_DB_PASSWORD: "test123"  # pragma: allowlist secret
      OAUTH_CACHE: mongo
      MONGO_DB_AUTH_CACHE_DISABLE_DELETE: 'true'
      # These values are for testing
      OAUTH_REFERRING_EMAIL: "admin@tester.com"
      OAUTH_REFERRING_SUBJECT: "admin@tester.com"
      # Sets base url for OAuth
      SERVER_BASE_URL: "https://mcpfhiragent.localhost/"
      # Token Exchange settings
      TOKEN_EXCHANGE_GRAPHQL_URL: 'https://api.client-sandbox.icanbwell.com/v1/graphql'
      # For storing clients in case of OAuth 2.1 Dynamic Client Registration
      MONGO_DYNAMIC_CLIENT_REGISTRATION_COLLECTION: "oauth-clients"
      MONGO_OAUTH_TRANSACTIONS_COLLECTION_NAME: "oauth-transactions"
      MONGO_OAUTH_CLIENT_CODES_COLLECTION_NAME: "oauth-client-codes"
      # Enable or disable MCP response caching middleware
      MCP_CACHING_ENABLED: ${MCP_CACHING_ENABLED:-true}
      # HTTP client configuration
      HTTP_MAX_CONNECTIONS: ${HTTP_MAX_CONNECTIONS:-200}
      HTTP_MAX_KEEPALIVE: ${HTTP_MAX_KEEPALIVE:-50}
      HTTP_RETRY_ATTEMPTS: ${HTTP_RETRY_ATTEMPTS:-3}
      HTTP_RETRY_BASE_DELAY_MS: ${HTTP_RETRY_BASE_DELAY_MS:-100}
      HTTP_TIMEOUT_SECONDS: ${HTTP_TIMEOUT_SECONDS:-30}
      # For talking to provider search service
      # PSS_BASE_URL: "https://provider-search.dev.bwell.zone/sdk/graphql"
      #      PSS_BASE_URL: "https://provider-search.staging.bwell.zone/graphql"
      PSS_BASE_URL: "https://provider-search.client-sandbox.bwell.zone/graphql"
      API_GATEWAY_BASE_URL: "https://api-gateway.client-sandbox.icanbwell.com/federated-graph-authed/graphql"
      # Test accounts
      TEST_USER_NAME: "tester"
      TEST_USER_PASSWORD: "password"
      # --- Configs for bailey ---
      DEFAULT_MODEL_PROVIDER: "bedrock"
      DEFAULT_MODEL_NAME: "us.anthropic.claude-sonnet-4-5-20250929-v1:0"
      # DEFAULT_MODEL_PROVIDER: "openai"
      # DEFAULT_MODEL_NAME: "gpt-4.1"
      DEFAULT_BEDROCK_MODEL_NAME: "us.anthropic.claude-sonnet-4-5-20250929-v1:0"
      DEFAULT_OPENAI_MODEL_NAME: "gpt-4o-mini"
      AWS_BEDROCK_MAX_RETRIES: '5'
      AWS_BEDROCK_RETRY_MODE: 'adaptive'
      MODELS_OFFICIAL_PATH: "/usr/src/mcp-fhir-agent-configs/local/chat_completions/official"
      MODELS_TESTING_PATH: "/usr/src/mcp-fhir-agent-configs/local/chat_completions/testing"
      RETURN_RAW_TOOL_OUTPUT: ${RETURN_RAW_TOOL_OUTPUT:-1}
      # Azure OpenAI settings
      AZURE_OPENAI_ENDPOINT: "https://bwell-ai.openai.azure.com/"
      AZURE_OPENAI_DEPLOYMENT: "gpt-4.1"
      AZURE_OPENAI_API_VERSION: "2024-12-01-preview"
      # Uses this model and ignores the model passed in if MODEL_OVERRIDE is set
      MODEL_OVERRIDE: ${MODEL_OVERRIDE:-}
      # ---- End bailey config ----
      # AWS_REGION: "us-east-2"
      # vector store for embeddings
      MONGO_VECTOR_DATABASE: data-science
      MONGO_VECTOR_EMBEDDINGS_COLLECTION: clinical-notes
      # vector index settings
      MONGO_VECTOR_INDEX_NAME: vector_index
      MONGO_VECTOR_INDEX_TYPE: vectorSearch
      MONGO_VECTOR_EMBEDDINGS_FIELD: embedding
      MONGO_VECTOR_DIMENSIONS: 1536
      MONGO_VECTOR_SIMILARITY: dotProduct
      MONGO_VECTOR_QUANTIZATION: scalar
      # embedding models
      #      EMBEDDING_MODEL: "arn:aws:bedrock:us-east-2::foundation-model/amazon.titan-embed-002"
      # https://docs.cohere.com/docs/cohere-embed
      EMBEDDING_MODEL: "cohere.embed-v4:0"
      EMBEDDING_MODEL_FAMILY: "cohere"
      EMBEDDING_MODEL_SUPPORTS_STREAMING: 0
      # This defines how big the chunks will be when splitting text for embeddings
      EMBEDDING_CHUNK_SIZE: 5000
      # this is what the embedding model can handle in one request
      EMBEDDING_MODEL_CONTEXT_WINDOW_SIZE: 128000  # Cohere Embed v4
      # These are for local embedding service testing
      LOCAL_EMBEDDING_SERVICE_URL: "http://text-embeddings"
      LOCAL_EMBEDDING_CONTEXT_WINDOW_SIZE: 512 # Hugging Face bge-large-en-v1.5
      LOCAL_EMBEDDING_MODEL: "BAAI/bge-large-en-v1.5"
      LOCAL_EMBEDDING_MODEL_FAMILY: "BAAI"
      LOCAL_MONGO_VECTOR_DIMENSIONS: 1024
      # JWT signing key
      # This is only used in the OAuth Dynamic Client Registration flow to sign client assertions
      JWT_SIGNING_KEY: ${JWT_SIGNING_KEY:-1acf47d258e5f8401cb0924ee7cba4ab}
      # Enable elicitation - if the Agent is unsure about what the user wants, it will ask follow-up questions
      ENABLE_ELICITATION: ${ENABLE_ELICITATION:-true}
    env_file: docker.env
    ports:
      - '5051:5000'
    volumes:
      - ../mcp-fhir-agent:/usr/src/mcp-fhir-agent/
      - ~/.config/gh:/root/.config/gh
      # uncomment this to use local fhir_to_llm code
      # - ../fhir_to_llm/fhir_to_llm:/usr/src/ai_agent_fhir/fhir_to_llm
      # ==== For bailey model testing - mount the AWS credentials ====
      # uncomment this for testing AWS models and the docker.env above (need the AWS_CREDENTIALS_PROFILE env var)
      - ~/.aws/:/etc/appuser/.aws/
    # uncomment the below to get the code from local folders instead of pypi
    #    - ../oidc-auth-lib/oidcauthlib:/usr/local/lib/python3.12/site-packages/oidcauthlib:ro
    command: [ "uvicorn", "mcpfhiragent.api:app", "--host", "0.0.0.0", "--port", "5000", "--reload", "--log-level", "debug" ]
    healthcheck:
      test: curl --fail -s http://localhost:5000/health || exit 1
    networks:
      - web

  # This is another instance of the mcp-fhir-agent but points to dev FHIR server
  mcp-fhir-agent-dev:
    image: mcp-fhir-agent:local
    environment:
      <<: *agent_env
      # You can override any environment variables here
      FHIR_SERVER_GET_URL: 'https://fhir.dev.icanbwell.com/4_0_0/'
      # Enable elicitation - if the Agent is unsure about what the user wants, it will ask follow-up questions
      # disable until language model gateway supports elicitation
      ENABLE_ELICITATION: "false"
    env_file: docker.env
    ports:
      - '5052:5000'
    volumes:
      - ../mcp-fhir-agent:/usr/src/mcp-fhir-agent/
      - ~/.config/gh:/root/.config/gh
      # uncomment this to use local fhir_to_llm code
      # - ../fhir_to_llm/fhir_to_llm:/usr/src/ai_agent_fhir/fhir_to_llm
      # ==== For bailey model testing - mount the AWS credentials ====
      # uncomment this for testing AWS models and the docker.env above (need the AWS_CREDENTIALS_PROFILE env var)
      - ~/.aws/:/etc/appuser/.aws/
    # uncomment the below to get the code from local folders instead of pypi
    #    - ../oidc-auth-lib/oidcauthlib:/usr/local/lib/python3.12/site-packages/oidcauthlib:ro
    command: [ "uvicorn", "mcpfhiragent.api:app", "--host", "0.0.0.0", "--port", "5000", "--reload", "--log-level", "debug" ]
    healthcheck:
      test: curl --fail -s http://localhost:5000/health || exit 1
    networks:
      - web

  # One-shot service to restore mongo db for testing
  mongo-restore-drop:
    image: mongo:6.0
    depends_on:
      mongo:
        condition: service_healthy
    networks:
      - web
    volumes:
      - ../mcp-fhir-agent/mongo_backup:/backup:ro
    environment:
      DB_NAME: fhir
      MONGO_USER: root
      MONGO_PASS: test123
      MONGO_HOST: mongo
      MONGO_PORT: 27017
    entrypoint: [ "/bin/bash", "-c" ]
    command:
      - >-
        echo "Waiting for MongoDB to be ready...";
        until mongosh --host "$${MONGO_HOST}" --port "$${MONGO_PORT}" --username "$${MONGO_USER}" --password "$${MONGO_PASS}" --authenticationDatabase admin --eval "db.adminCommand('ping')" --quiet > /dev/null 2>&1; do
          echo "MongoDB is unavailable - sleeping";
          sleep 2;
        done;
        echo "MongoDB is ready!";
        if [ ! -d /backup/$${DB_NAME} ]; then echo "Error: backup directory /backup/$${DB_NAME} not found" >&2; exit 1; fi;
        mongorestore --host "$${MONGO_HOST}" --port "$${MONGO_PORT}" --username "$${MONGO_USER}" --password "$${MONGO_PASS}" --authenticationDatabase admin --drop --db "$${DB_NAME}" /backup/$${DB_NAME} && echo "Restore completed"

networks:
  web:
    external: true
    name: language-model-gateway_web