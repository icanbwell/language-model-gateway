services:
  aspire-dashboard:
    image: mcr.microsoft.com/dotnet/aspire-dashboard:latest
    environment:
      # Listen on default ports; dashboard UI and OTLP ingestion
      ASPNETCORE_URLS: "http://0.0.0.0:18888"
      # Enable OpenTelemetry ingestion (HTTP/Protobuf). The dashboard image exposes 18889 for OTLP.
      DASHBOARD_OTLP_HTTP_ENDPOINT_URLS: "http://0.0.0.0:18889"
    ports:
      - "18888:18888"  # Dashboard UI
      - "18889:18889"  # OTLP HTTP ingestion
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:18888/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - web

  language-model-gateway:
    # Reuse the base service definition but override/add OTEL env vars so it exports to Aspire
    extends:
      service: language-model-gateway
      file: docker-compose.yml
    environment:
      OTEL_SERVICE_NAME: "language-model-gateway"
      OTEL_RESOURCE_ATTRIBUTES: "deployment.environment=local"
      # Export traces and metrics via OTLP HTTP to Aspire Dashboard
      OTEL_TRACES_EXPORTER: "otlp"
      OTEL_METRICS_EXPORTER: "otlp"
      OTEL_EXPORTER_OTLP_PROTOCOL: "http/protobuf"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://aspire-dashboard:18889"
      # Optional: enable logs if desired in future (Aspire focuses on traces/metrics)
      # OTEL_LOGS_EXPORTER: "otlp"
    depends_on:
      aspire-dashboard:
        condition: service_started
    networks:
      - web

networks:
  web:
    external: true
    name: language-model-gateway_web


