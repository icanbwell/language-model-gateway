services:
  # Jaeger all-in-one provides collector (including OTLP), query, and UI in one container
  jaeger:
    image: jaegertracing/jaeger:2.13.0
    restart: unless-stopped
    logging:
      options:
        max-size: 50m
        max-file: "3"
    environment:
      # Enable OTLP HTTP and gRPC receivers
      - COLLECTOR_OTLP_ENABLED=true
      - COLLECTOR_OTLP_HTTP_ENABLED=true
      # Optional: reduce memory usage
      - MEMORY_MAX_TRACES=50000
    ports:
      - "16686:16686" # Jaeger UI
      - "4317:4317"   # OTLP gRPC receiver
      - "4318:4318"   # OTLP HTTP receiver
    networks:
      - web
#    healthcheck:
#      test: ["CMD-SHELL", "curl --fail -s http://localhost:16686/ || exit 1"]
#      interval: 10s
#      timeout: 5s
#      retries: 5
#      start_period: 20s

  # OpenTelemetry Collector to aggregate and forward telemetry to Aspire
  otel-collector:
    image: otel/opentelemetry-collector:0.102.0
    command: [ "--config=/etc/otelcol/config.yaml" ]
    volumes:
      - ./observability/otel-collector-config.yaml:/etc/otelcol/config.yaml:ro
    restart: unless-stopped
    logging:
      options:
        max-size: 50m
        max-file: "3"
    depends_on:
      jaeger:
        condition: service_started
    networks:
      - web
#    healthcheck:
#      test: ["CMD-SHELL", "curl --fail -s http://0.0.0.0:13133/health || exit 1"]
#      interval: 10s
#      timeout: 5s
#      retries: 5
#      start_period: 20s

  language-model-gateway:
    extends:
      service: language-model-gateway
      file: docker-compose.yml
    restart: unless-stopped
    logging:
      options:
        max-size: 50m
        max-file: "3"
    environment:
      OTEL_SERVICE_NAME: "language-model-gateway"
      # https://opentelemetry.io/docs/zero-code/python/
      # https://opentelemetry.io/docs/zero-code/python/configuration/
      OTEL_RESOURCE_ATTRIBUTES: "deployment.environment=local"
      # Export traces and metrics via OTLP gRPC to the local collector
      OTEL_TRACES_EXPORTER: "otlp"
      # OTEL_METRICS_EXPORTER: "console,otlp"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://otel-collector:4317"
      OTEL_EXPORTER_OTLP_TRACES_PROTOCOL: "grpc"
      OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
      OTEL_TRACES_SAMPLER: "always_on"
      OTEL_PYTHON_FASTAPI_EXCLUDED_URLS: "/health,/metrics"
      # Enable metrics export via OTLP gRPC
      OTEL_METRICS_EXPORTER: "otlp"
      OTEL_EXPORTER_OTLP_METRICS_PROTOCOL: "grpc"
      # Optional: enable logs in future
      # OTEL_LOGS_EXPORTER: "otlp"
    depends_on:
      otel-collector:
        condition: service_started
    networks:
      - web

  open-webui:
    extends:
      service: open-webui
      file: docker-compose-openwebui.yml
    restart: unless-stopped
    logging:
      options:
        max-size: 50m
        max-file: "3"
    environment:
      ENABLE_OTEL: "true"
      # OpenWebUI has a lot of traces so disable unless needed for troubleshooting
      ENABLE_OTEL_TRACES: "false"
      ENABLE_OTEL_METRICS: "false"
      OTEL_SERVICE_NAME: "open-webui"
      OTEL_RESOURCE_ATTRIBUTES: "deployment.environment=local"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://otel-collector:4317"
      OTEL_EXPORTER_OTLP_INSECURE: "true"
      OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
      OTEL_TRACES_SAMPLER: "always_on"
      # Exclude health endpoint if applicable
      OTEL_PYTHON_FASTAPI_EXCLUDED_URLS: "/health"
      # Enable tracing for web frameworks (OpenWebUI is FastAPI-based)
      OTEL_PYTHON_TRACER_PROVIDER: "sdk"
      # Enable metrics export via OTLP gRPC
      OTEL_METRICS_EXPORTER: "otlp"
      OTEL_EXPORTER_OTLP_METRICS_PROTOCOL: "grpc"
    depends_on:
      otel-collector:
        condition: service_started
    networks:
      - web

networks:
  web:
    external: true
    name: language-model-gateway_web
